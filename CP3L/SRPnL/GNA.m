function [R, t, s, err] = GNA(xs, xe, Pn1_w, Pn2_w, R0)

%first compute the weight of each line and the normal of the interpretation plane passing through to camera center and the line 
s0 = [CGR(R0);Pn2_w(1,1);Pn2_w(2,2);Pn2_w(3,3)];

npart = 3;  
neLine = length(xs);
ne_c=xnorm(cross(xs,xe));

Q=zeros(2*neLine,34);
N=zeros(2*neLine,3);
nx=ne_c(1,1:npart)'; ny=ne_c(2,1:npart)'; nz=ne_c(3,1:npart)';
Px=Pn1_w(1,1:npart)'; Py=Pn1_w(2,1:npart)'; Pz=Pn1_w(3,1:npart)';
Q(1:2:2*npart,:)=[Px.*nx+Py.*ny+Pz.*nz,...    %1
          2*Py.*nz-2*Pz.*ny,...       %s1
          2*Pz.*nx-2*Px.*nz,...       %s2
          2*Px.*ny-2*Py.*nx,...       %s3
          Px.*nx-Py.*ny-Pz.*nz,...     %s1^2
          2.*Px.*ny+2*Py.*nx,...      %s1*s2
          2.*Px.*nz+2*Pz.*nx,...       %s1*s3
          Py.*ny-Px.*nx-Pz.*nz,...     %s2^2
          2*Py.*nz+2*Pz.*ny,...       %s2*s3
          Pz.*nz-Px.*nx-Py.*ny,...     %s3^2
          [0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0]];
nx=ne_c(1,1)'; ny=ne_c(2,1)'; nz=ne_c(3,1)';      
Py=Pn2_w(2,1)'; Pz=Pn2_w(3,1)';
Q(2,:)=[Py.*ny+Pz.*nz,...
          2*Py.*nz-2*Pz.*ny,...
          2*Pz.*nx,...
          -2*Py.*nx,...
          -Py.*ny-Pz.*nz,...
          2*Py.*nx,...
          2*Pz.*nx,...
          Py.*ny-Pz.*nz,...
          2*Py.*nz+2*Pz.*ny,...
          Pz.*nz-Py.*ny,...
          nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
nx=ne_c(1,2)'; ny=ne_c(2,2)'; nz=ne_c(3,2)';
Px=Pn2_w(1,2)'; Pz=Pn2_w(3,2)';
Q(4,:)=[Px.*nx+Pz.*nz,...
          -2*Pz.*ny,...
          2*Pz.*nx-2*Px.*nz,...
          2*Px.*ny,...
          Px.*nx-Pz.*nz,...
          2.*Px.*ny,...
          2.*Px.*nz+2*Pz.*nx,...
          -Px.*nx-Pz.*nz,...
          2*Pz.*ny,...
          Pz.*nz-Px.*nx,...
          0,0,0,0,0,0,0,0,ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny,0,0,0,0,0,0,0,0];  
nx=ne_c(1,3)'; ny=ne_c(2,3)'; nz=ne_c(3,3)';
Px=Pn2_w(1,3)'; Py=Pn2_w(2,3)';
Q(6,:)=[Px.*nx+Py.*ny,...
          2*Py.*nz,...
          -2*Px.*nz,...
          2*Px.*ny-2*Py.*nx,...
          Px.*nx-Py.*ny,...
          2.*Px.*ny+2*Py.*nx,...
          2.*Px.*nz,...
          Py.*ny-Px.*nx,...
          2*Py.*nz,...
          -Px.*nx-Py.*ny,...
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];


nx=ne_c(1,4)'; ny=ne_c(2,4)'; nz=ne_c(3,4)';      
Py=Pn1_w(2,4)'; Pz=Pn1_w(3,4)';
Q(7,:)=[Py.*ny+Pz.*nz,...
          2*Py.*nz-2*Pz.*ny,...
          2*Pz.*nx,...
          -2*Py.*nx,...
          -Py.*ny-Pz.*nz,...
          2*Py.*nx,...
          2*Pz.*nx,...
          Py.*ny-Pz.*nz,...
          2*Py.*nz+2*Pz.*ny,...
          Pz.*nz-Py.*ny,...
          nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
Px=Pn2_w(1,4)'; Pz=Pn2_w(3,4)';
Q(8,:)=[Px.*nx+Pz.*nz,...
          -2*Pz.*ny,...
          2*Pz.*nx-2*Px.*nz,...
          2*Px.*ny,...
          Px.*nx-Pz.*nz,...
          2.*Px.*ny,...
          2.*Px.*nz+2*Pz.*nx,...
          -Px.*nx-Pz.*nz,...
          2*Pz.*ny,...
          Pz.*nz-Px.*nx,...
          0,0,0,0,0,0,0,0,   ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny,0,0,0,0,0,0,0,0];        

nx=ne_c(1,5)'; ny=ne_c(2,5)'; nz=ne_c(3,5)';      
Px=Pn1_w(1,5)'; Pz=Pn1_w(3,5)';
Q(9,:)=[Px.*nx+Pz.*nz,...
          -2*Pz.*ny,...
          2*Pz.*nx-2*Px.*nz,...
          2*Px.*ny,...
          Px.*nx-Pz.*nz,...
          2.*Px.*ny,...
          2.*Px.*nz+2*Pz.*nx,...
          -Px.*nx-Pz.*nz,...
          2*Pz.*ny,...
          Pz.*nz-Px.*nx,...
          0,0,0,0,0,0,0,0,   ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny,0,0,0,0,0,0,0,0];        
Px=Pn2_w(1,5)'; Py=Pn2_w(2,5)';
Q(10,:)=[Px.*nx+Py.*ny,...
          2*Py.*nz,...
          -2*Px.*nz,...
          2*Px.*ny-2*Py.*nx,...
          Px.*nx-Py.*ny,...
          2.*Px.*ny+2*Py.*nx,...
          2.*Px.*nz,...
          Py.*ny-Px.*nx,...
          2*Py.*nz,...
          -Px.*nx-Py.*ny,...
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];

nx=ne_c(1,6)'; ny=ne_c(2,6)'; nz=ne_c(3,6)';      
Px=Pn1_w(1,6)'; Py=Pn1_w(2,6)';
Q(11,:)=[Px.*nx+Py.*ny,...
          2*Py.*nz,...
          -2*Px.*nz,...
          2*Px.*ny-2*Py.*nx,...
          Px.*nx-Py.*ny,...
          2.*Px.*ny+2*Py.*nx,...
          2.*Px.*nz,...
          Py.*ny-Px.*nx,...
          2*Py.*nz,...
          -Px.*nx-Py.*ny,...
          0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];
Py=Pn2_w(2,6)'; Pz=Pn2_w(3,6)';
Q(12,:)=[Py.*ny+Pz.*nz,...
          2*Py.*nz-2*Pz.*ny,...
          2*Pz.*nx,...
          -2*Py.*nx,...
          -Py.*ny-Pz.*nz,...
          2*Py.*nx,...
          2*Pz.*nx,...
          Py.*ny-Pz.*nz,...
          2*Py.*nz+2*Pz.*ny,...
          Pz.*nz-Py.*ny,...
          nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];

N(1:2:2*neLine,:)=-ne_c.';
N(2:2:2*neLine,:)=-ne_c.';

if abs(det(N.'*N)) < 2e-10
    CC=(pinv(N.'*N)*N.')*Q;
else
    CC=((N.'*N)\N.')*Q;
end

EE=Q-N*CC;
GG=EE.'*EE;


s1=s0(1);
s2=s0(2);
s3=s0(3);
s4=s0(4);
s5=s0(5);
s6=s0(6);
% factor=1/(1+s1^2+s2^2+s3^2);

sr=[1,s1,s2,s3,s1^2,s1*s2,s1*s3,s2^2,s2*s3,s3^2,...
s4,s4*s2,s4*s3,s4*(s1^2),s4*s1*s2,s4*s1*s3,s4*(s2^2),s4*(s3^2),...
s5,s5*s1,s5*s3,s5*(s1^2),s5*s1*s2,s5*(s2^2),s5*s2*s3,s5*(s3^2),...
s6,s6*s1,s6*s2,s6*(s1^2),s6*s1*s3,s6*(s2^2),s6*s2*s3,s6*(s3^2)].';       
% t=factor*CC*sr; 

err_pref = sr' * GG * sr;


% ans1 = s0';
% options=optimoptions(@fsolve,'Algorithm', 'levenberg-marquardt');
% count = 1;
% for k=1:300
%     [x,fval,exitflag,output]=fsolve(@(s) solveproblem(s,EE),s0,options);
%     s0=x;
%     s1=s0(1);
%     s2=s0(2);
%     s3=s0(3);
%     s4=s0(4);
%     s5=s0(5);
%     s6=s0(6);
%     % factor=1/(1+s1^2+s2^2+s3^2);
% 
%     sr=[1,s1,s2,s3,s1^2,s1*s2,s1*s3,s2^2,s2*s3,s3^2,...
%     s4,s4*s2,s4*s3,s4*(s1^2),s4*s1*s2,s4*s1*s3,s4*(s2^2),s4*(s3^2),...
%     s5,s5*s1,s5*s3,s5*(s1^2),s5*s1*s2,s5*(s2^2),s5*s2*s3,s5*(s3^2),...
%     s6,s6*s1,s6*s2,s6*(s1^2),s6*s1*s3,s6*(s2^2),s6*s2*s3,s6*(s3^2)].';       
%     % t=factor*CC*sr; 
% 
%     err_cur = sr' * GG * sr;
%     if abs(err_cur) < abs(err_pref)
%         ans1(count,:)=x;
%         count = count+1;
%         err_pref = err_cur;
%     end
% end


s= GaussNewton(EE,s0);

% s = ans1(end,:);

R= CGR2(s(1:3));
x = R(:);

s1=s(1);
s2=s(2);
s3=s(3);
s4=s(4);
s5=s(5);
s6=s(6);
factor=1/(1+s1^2+s2^2+s3^2);

sr=[1,s1,s2,s3,s1^2,s1*s2,s1*s3,s2^2,s2*s3,s3^2,...
s4,s4*s2,s4*s3,s4*(s1^2),s4*s1*s2,s4*s1*s3,s4*(s2^2),s4*(s3^2),...
s5,s5*s1,s5*s3,s5*(s1^2),s5*s1*s2,s5*(s2^2),s5*s2*s3,s5*(s3^2),...
s6,s6*s1,s6*s2,s6*(s1^2),s6*s1*s3,s6*(s2^2),s6*s2*s3,s6*(s3^2)].';   

t=factor*CC*sr; 

err = sr' * GG * sr;

return

function c = xcross(a,b)

c = [a(2)*b(3)-a(3)*b(2);
     a(3)*b(1)-a(1)*b(3);
     a(1)*b(2)-a(2)*b(1)];
 
return
 
function s= CGR(R)

A= R.';

q4= sqrt(1+A(1,1)+A(2,2)+A(3,3))/2;

if q4 > 0.01
	q1= (A(3,2)-A(2,3))/q4/4;
	q2= (A(1,3)-A(3,1))/q4/4;
	q3= (A(2,1)-A(1,2))/q4/4;
else
	q1= sqrt(1+A(1,1)-A(2,2)-A(3,3))/2;
	q2= (A(1,2)+A(2,1))/q1/4;
	q3= (A(1,3)+A(3,1))/q1/4;
	q4= (A(3,2)-A(2,3))/q1/4;
end

s= -[q1; q2; q3]/q4;

return

function R= CGR2(s)

s1= s(1);
s2= s(2);
s3= s(3);

R= [1+s1^2-s2^2-s3^2,   2*s1*s2-2*s3,   2*s2+2*s1*s3;
    2*s3+2*s1*s2,   1-s1^2+s2^2-s3^2,   2*s2*s3-2*s1;
    2*s1*s3-2*s2,   2*s1+2*s2*s3,   1-s1^2-s2^2+s3^2];
 
R= R/(1+s1*s1+s2*s2+s3*s3);

return

function s= GaussNewton(m,s0)

A1= [...
0;
0;
0;
2*(14)+ 2*(48)+ 2*(82)+ 2*(116)+ 2*(150)+ 2*(184)+ 2*(218)+ 2*(252)+ 2*(286)+ 2*(320)+ 2*(354)+ 2*(388);
2*m(22)+ 2*m(56)+ 2*m(90)+ 2*m(124)+ 2*m(158)+ 2*m(192)+ 2*m(226)+ 2*m(260)+ 2*m(294)+ 2*m(328)+ 2*m(362)+ 2*m(396);
2*m(30) + 2*m(64) + 2*m(98) + 2*m(132) + 2*m(166) + 2*m(200) + 2*m(234) + 2*m(268) + 2*m(302) + 2*m(336) + 2*m(370) + 2*m(404);
2*m(5) + 2*m(39) + 2*m(73) + 2*m(107) + 2*m(141) + 2*m(175) + 2*m(209) + 2*m(243) + 2*m(277)+ 2*m(311) + 2*m(345) + 2*m(379);
0;
0;
m(15)+ m(49)+ m(83)+ m(117)+ m(151)+ m(185)+ m(219)+ m(253)+ m(287)+ m(321)+ m(355)+ m(389);
m(23)+ m(57)+ m(91)+ m(125)+ m(159)+ m(193)+ m(227)+ m(261)+ m(295)+ m(329)+ m(363)+ m(397);
0;
m(6) + m(40) + m(74) + m(108) + m(142) + m(176) + m(210) + m(244) + m(278) + m(312) + m(346) + m(380);
0;
m(16) + m(50) + m(84) + m(118) + m(152) + m(186) + m(220) + m(254) + m(288) + m(322) + m(356) + m(390);
0;
m(31) + m(65) + m(99) + m(133) + m(167) + m(201) + m(235) + m(269) + m(303) + m(337) + m(371) + m(405);
m(7) + m(41) + m(75) + m(109) + m(143) + m(177) + m(211) + m(245) + m(279) + m(313) + m(347) + m(381);
0;
m(20) + m(54) + m(88) + m(122) + m(156) + m(190) + m(224) + m(258) + m(292) + m(326) + m(360) + m(394);
m(28) + m(62) + m(96) + m(130) + m(164) + m(198) + m(232) + m(266) + m(300) + m(334) + m(368) + m(402);
m(2) + m(36) + m(70) + m(104) + m(138) + m(172)+ m(206)+ m(240)+ m(274)+ m(308)+ m(342)+ m(376)];



A2= [...
0;
0;
0;
m(15) + m(49) + m(83) + m(117) + m(151) + m(185) + m(219) + m(253) + m(287) + m(321) + m(355) + m(389);
m(23) + m(57) + m(91) + m(125) + m(159) + m(193) + m(227) + m(261) + m(295) + m(329) + m(363) + m(397);
0;
m(6) + m(40) + m(74) + m(108) + m(142) + m(176) + m(210) + m(244) + m(278) + m(312) + m(346) + m(380);
0;
0;
2*m(17) + 2*m(51) + 2*m(85) + 2*m(119) + 2*m(153) + 2*m(187) + 2*m(221) + 2*m(255) + 2*m(289) + 2*m(323) + 2*m(357) + 2*m(391);
2*m(24) + 2*m(58) + 2*m(92) + 2*m(126) + 2*m(160) + 2*m(194) + 2*m(228) + 2*m(262) + 2*m(296) + 2*m(330) + 2*m(364) + 2*m(398);
2*m(32) + 2*m(66)+ 2*m(100)+ 2*m(134)+ 2*m(168)+ 2*m(202)+ 2*m(236)+ 2*m(270)+ 2*m(304)+ 2*m(338)+ 2*m(372)+ 2*m(406);
2*m(8)+ 2*m(42)+ 2*m(76)+ 2*m(110)+ 2*m(144)+ 2*m(178)+ 2*m(212)+ 2*m(246)+ 2*m(280)+ 2*m(314)+ 2*m(348)+ 2*m(382);
0;
0;
m(25) + m(59)+ m(93)+ m(127)+ m(161)+ m(195)+ m(229)+ m(263)+ m(297)+ m(331)+ m(365)+ m(399);
m(33)+ m(67)+ m(101)+ m(135)+ m(169)+ m(203 )+ m(237)+ m(271)+ m(305)+ m(339)+ m(373)+ m(407);
m(9) + m(43)+ m(77)+ m(111)+ m(145)+ m(179)+ m(213)+ m(247)+ m(281)+ m(315)+ m(349)+ m(383);
m(12) + m(46)+ m(80)+ m(114)+ m(148)+ m(182)+ m(216 )+ m(250)+ m(284)+ m(318)+ m(352)+ m(386);
0;
m(29)+ m(63)+ m(97)+ m(131)+ m(165)+ m(199)+ m(233)+ m(267)+ m(301)+ m(335)+ m(369)+ m(403);
m(3)+ m(37)+ m(71)+ m(105)+ m(139)+ m(173)+ m(207)+ m(241)+ m(275)+ m(309)+ m(343)+ m(377)];


A3= [...
0;
0;
0;
m(16)+ m(50)+ m(84)+ m(118)+ m(152)+ m(186)+ m(220)+ m(254)+ m(288)+ m(322)+ m(356)+ m(390);
0;
m(31)+ m(65)+ m(99)+ m(133)+ m(167)+ m(201)+ m(235)+ m(269)+ m(303)+ m(337)+ m(371)+ m(405);
m(7)+ m(41)+ m(75)+ m(109)+ m(143)+ m(177)+ m(211)+ m(245)+ m(279)+ m(313)+ m(347)+ m(381);
0;
0;
0;
m(25)+ m(59)+ m(93)+ m(127)+ m(161)+ m(195)+ m(229)+ m(263)+ m(297)+ m(331)+ m(365)+ m(399);
m(33)+ m(67)+ m(101)+ m(135)+ m(169)+ m(203 )+ m(237)+ m(271)+ m(305)+ m(339)+ m(373 )+ m(407);
m(9)+ m(43)+ m(77)+ m(111)+ m(145)+ m(179)+ m(213)+ m(247)+ m(281)+ m(315)+ m(349)+ m(383);
0;
2*m(18)+ 2*m(52)+ 2*m(86)+ 2*m(120)+ 2*m(154)+ 2*m(188)+ 2*m(222)+ 2*m(256)+ 2*m(290)+ 2*m(324)+ 2*m(358)+ 2*m(392);
2*m(26)+ 2*m(60)+ 2*m(94)+ 2*m(128)+ 2*m(162)+ 2*m(196)+ 2*m(230)+ 2*m(264)+ 2*m(298)+ 2*m(332)+ 2*m(366)+ 2*m(400);
2*m(34)+ 2*m(68)+ 2*m(102)+ 2*m(136)+ 2*m(170)+ 2*m(204)+ 2*m(238)+ 2*m(272)+ 2*m(306)+ 2*m(340)+ 2*m(374)+ 2*m(408);
2*m(10)+ 2*m(44)+ 2*m(78)+ 2*m(112)+ 2*m(146)+ 2*m(180)+ 2*m(214)+ 2*m(248)+ 2*m(282)+ 2*m(316)+ 2*m(350)+ 2*m(384);
m(13)+ m(47)+ m(81)+ m(115)+ m(149)+ m(183)+ m(217)+ m(251)+ m(285)+ m(319)+ m(353)+ m(387);
m(21)+  m(55)+  m(89)+  m(123)+  m(157)+  m(191)+  m(225)+  m(259)+  m(293)+  m(327)+  m(361)+ m(395);
0;
m(4)+ m(38)+ m(72)+ m(106)+ m(140)+ m(174)+ m(208)+ m(242)+ m(276)+ m(310)+ m(344)+ m(378)];

A4= [...
m(14)+ m(48 )+ m(82 )+ m(116)+ m(150)+ m(184)+ m(218)+ m(252)+ m(286)+ m(320)+ m(354)+ m(388);
m(15)+ m(49)+ m(83)+ m(117)+ m(151)+ m(185)+ m(219)+ m(253)+ m(287)+ m(321)+ m(355)+ m(389);
m(16)+ m(50)+ m(84)+ m(118)+ m(152)+ m(186)+ m(220)+ m(254)+ m(288)+ m(322)+ m(356)+ m(390);
0;
0;
0;
0;
m(17)+ m(51)+ m(85)+ m(119)+ m(153)+ m(187)+ m(221)+ m(255)+ m(289)+ m(323)+ m(357)+ m(391);
0;
0;
0;
0;
m(12)+ m(46)+ m(80)+ m(114)+ m(148)+ m(182)+ m(216)+ m(250)+ m(284)+ m(318)+ m(352)+ m(386);
m(18)+ m(52)+ m(86)+ m(120)+ m(154)+ m(188)+ m(222)+ m(256)+ m(290)+ m(324)+ m(358)+ m(392);
0;
0;
0;
m(13)+ m(47)+ m(81)+ m(115)+ m(149)+ m(183)+ m(217)+ m(251)+ m(285)+ m(319)+ m(353)+ m(387);
0;
0;
0;
m(11)+ m(45)+ m(79)+ m(113)+ m(147)+ m(181)+ m(215)+ m(249)+ m(283)+ m(317)+ m(351)+ m(385)];


A5= [...
m(22)+ m(56)+ m(90)+ m(124)+ m(158)+ m(192)+ m(226)+ m(260)+ m(294)+ m(328)+ m(362)+ m(396);
m(23)+ m(57)+ m(91)+ m(125)+ m(159)+ m(193)+ m(227)+ m(261)+ m(295)+ m(329)+ m(363)+ m(397);
0;
0;
0;
0;
m(20)+ m(54)+ m(88)+ m(122)+ m(156)+ m(190)+ m(224)+ m(258)+ m(292)+ m(326)+ m(360)+ m(394);
m(24)+ m(58)+ m(92)+ m(126)+ m(160)+ m(194)+ m(228)+ m(262)+ m(296)+ m(330)+ m(364)+ m(398);
m(25)+ m(59)+ m(93)+ m(127)+ m(161)+ m(195)+ m(229)+ m(263)+ m(297)+ m(331)+ m(365)+ m(399);
0;
0;
0;
0;
m(26)+ m(60)+ m(94)+ m(128)+ m(162)+ m(196)+ m(230)+ m(264)+ m(298)+ m(332)+ m(366)+ m(400);
0;
0;
0;
m(21)+ m(55)+ m(89)+ m(123)+ m(157)+ m(191)+ m(225)+ m(259)+ m(293)+ m(327)+ m(361)+ m(395);
0;
0;
0;
m(19)+ m(53)+ m(87)+ m(121)+ m(155)+ m(189)+ m(223)+ m(257)+ m(291)+ m(325)+ m(359)+ m(393)];

A6= [...
m(30)+ m(64)+ m(98)+ m(132)+ m(166)+ m(200)+ m(234)+ m(268)+ m(302)+ m(336)+ m(370)+ m(404);
0;
m(31)+ m(65)+ m(99)+ m(133)+ m(167)+ m(201)+ m(235)+ m(269)+ m(303)+ m(337)+ m(371)+ m(405);
0;
0;
0;
m(28)+ m(62)+ m(96)+ m(130)+ m(164)+ m(198)+ m(232)+ m(266)+ m(300)+ m(334)+ m(368)+ m(402);
m(32)+ m(66)+ m(100)+ m(134)+ m(168)+ m(202)+ m(236)+ m(270)+ m(304)+ m(338)+ m(372)+ m(406);
m(33)+ m(67)+ m(101)+ m(135)+ m(169)+ m(203)+ m(237)+ m(271)+ m(305)+ m(339)+ m(373)+ m(407);
0;
0;
0;
m(29)+ m(63 )+ m(97)+ m(131)+ m(165)+ m(199)+ m(233 )+ m(267)+ m(301)+ m(335)+ m(369)+ m(403);
m(34)+ m(68)+ m(102)+ m(136)+ m(170)+ m(204)+ m(238)+ m(272)+ m(306)+ m(340)+ m(374)+ m(408);
0;
0;
0;
0;
0;
0;
0;
m(27)+ m(61)+ m(95)+ m(129)+ m(163)+ m(197)+ m(231)+ m(265)+ m(299)+ m(333)+ m(367)+ m(401)];


s= s0;

pref= 10000;

for i= 1:100
    
    s1= s(1);
    s2= s(2);
    s3= s(3);
    s4= s(4);
    s5= s(5);
    s6= s(6);

    vecs= [s1^2 , s1*s2 , s1*s3 , s1*s4 , s1*s5 , s1*s6 , s1 , s2^2 , s2*s3 , s2*s4 , s2*s5 , s2*s6 , s2 , s3^2 , s3*s4 , s3*s5 , s3*s6 , s3 , s4 , s5 , s6, 1];

    vecs1= [ 2*s1, s2, s3, s4, s5, s6, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
    vecs2= [ 0, s1, 0, 0, 0, 0, 0, 2*s2, s3, s4, s5, s6, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0];
    vecs3= [ 0, 0, s1, 0, 0, 0, 0, 0, s2, 0, 0, 0, 0, 2*s3, s4, s5, s6, 1, 0, 0, 0, 0];
    vecs4= [ 0, 0, 0, s1, 0, 0, 0, 0, 0, s2, 0, 0, 0, 0, s3, 0, 0, 0, 1, 0, 0, 0];
    vecs5= [ 0, 0, 0, 0, s1, 0, 0, 0, 0, 0, s2, 0, 0, 0, 0, s3, 0, 0, 0, 1, 0, 0];
    vecs6= [ 0, 0, 0, 0, 0, s1, 0, 0, 0, 0, 0, s2, 0, 0, 0, 0, s3, 0, 0, 0, 1, 0];

    f1= vecs*A1;
    f2= vecs*A2;
    f3= vecs*A3;
    f4= vecs*A4;
    f5= vecs*A5;
    f6= vecs*A6;

    curf= f1*f1+f2*f2+f3*f3+f4*f4+f5*f5+f6*f6;
    if curf > pref
	break;
    end

    pref= curf;

    f11= vecs1*A1;
    f12= vecs2*A1;
    f13= vecs3*A1;
    f14= vecs4*A1;
    f15= vecs5*A1;
    f16= vecs6*A1;

    f21= vecs1*A2;
    f22= vecs2*A2;
    f23= vecs3*A2;
    f24= vecs4*A2;
    f25= vecs5*A2;
    f26= vecs6*A2;

    f31= vecs1*A3;
    f32= vecs2*A3;
    f33= vecs3*A3;
    f34= vecs4*A3;
    f35= vecs5*A3;
    f36= vecs6*A3;
    
    f41= vecs1*A4;
    f42= vecs2*A4;
    f43= vecs3*A4;
    f44= vecs4*A4;
    f45= vecs5*A4;
    f46= vecs6*A4;
    
    f51= vecs1*A5;
    f52= vecs2*A5;
    f53= vecs3*A5;
    f54= vecs4*A5;
    f55= vecs5*A5;
    f56= vecs6*A5;
    
    f61= vecs1*A6;
    f62= vecs2*A6;
    f63= vecs3*A6;
    f64= vecs4*A6;
    f65= vecs5*A6;
    f66= vecs6*A6;
    
    

    H= [f11 f12 f13 f14 f15 f16; f21 f22 f23 f24 f25 f26; f31 f32 f33 f34 f35 f36; f41 f42 f43 f44 f45 f46; f51 f52 f53 f54 f55 f56; f61 f62 f63 f64 f65 f66];
    
    s= s- H\[f1; f2; f3; f4; f5; f6];
    
end


function output=solveproblem(s,EE)
s1= s(1);
s2= s(2);
s3= s(3);
s4= s(4);
s5= s(5);
s6= s(6);
w=[1,s1,s2,s3,s1^2,s1*s2,s1*s3,s2^2,s2*s3,s3^2,...
        s4,s4*s2,s4*s3,s4*(s1^2),s4*s1*s2,s4*s1*s3,s4*(s2^2),s4*(s3^2),...
        s5,s5*s1,s5*s3,s5*(s1^2),s5*s1*s2,s5*(s2^2),s5*s2*s3,s5*(s3^2),...
        s6,s6*s1,s6*s2,s6*(s1^2),s6*s1*s3,s6*(s2^2),s6*s2*s3,s6*(s3^2)].';
[m,~] = size(EE);
for i = 1:m
    output(i) = EE(i,:)*w;
end
