close all;
clc;
clear;

addpath LPnL-Bar-ENull;
addpath others;
addpath ASPnL;
addpath RPnL;
addpath SRPnL;

%Type0 Room Camera Pose Estimation

% Group One

% pointS(1,1:5) = [256, 0, 256, 93.70619386809568, 575.2244843975153];
% pointS(2,1:5) = [256, 256, 256, 92.86556007024905, 86.79395577579675];
% pointS(3,1:5) = [256, 0, 256, 93.70619386809568, 575.2244843975153];
% pointS(4,1:5) = [512, 0, 256, 599.4744419461035, 574.4126910202073];
% pointS(5,1:5) = [256, 0, 256, 93.70619386809568, 575.2244843975153];
% pointS(6,1:5) = [256, 256, 256, 92.86556007024905, 86.79395577579675];
% pointS(7,1:5) = [512, 256, 256, 581.2017659041953, 69.7891653683385];
% pointS(8,1:5) = [512, 0, 256, 599.4744419461035, 574.4126910202073];

% pointE(1,1:5) = [256, 256, 256, 92.86556007024905, 86.79395577579675];
% pointE(2,1:5) = [512, 256, 256, 581.2017659041953, 69.7891653683385];
% pointE(3,1:5) = [512, 0, 256, 599.4744419461035, 574.4126910202073];
% pointE(4,1:5) = [512, 256, 256, 581.2017659041953, 69.7891653683385];
% 
% pointE(5,1:5) = [256, 0, pointS(5,3)+10, 36.68728457194504, 630.6464130669883];
% pointE(6,1:5) = [256, 256, pointS(6,3)+10, 37.98274419214039, 30.553609359902225];
% pointE(7,1:5) = [512, 256, pointS(7,3)+10, 637.9327506436568, 7.280697470726068];
% pointE(8,1:5) = [512, 0, pointS(8,3)+10, 627.8651165545643, 600.084505502598];


% Group Two
% pointS(1,1:5) = [0, 0, 0, 190.92440471502894, 469.5029673620867];
% pointS(2,1:5) = [0, 256, 0, 151.8202636800106, 152.06318551934396];
% pointS(3,1:5) = [256, 256, 0, 514.2982592824391, 99.57966014922755];
% pointS(4,1:5) = [256, 0, 0, 514.1994459262231, 468.46125329551046];
% 
% pointS(5,1:5) = [0, 0, 0, 190.92440471502894, 469.5029673620867];
% pointS(6,1:5) = [0, 256, 0, 151.8202636800106, 152.06318551934396];
% pointS(7,1:5) = [256, 256, 0, 514.2982592824391, 99.57966014922755];
% pointS(8,1:5) = [256, 0, 0, 514.1994459262231, 468.46125329551046];
% 
% 
% pointE(1,1:5) = [0, 256, 0, 151.8202636800106, 152.06318551934396];
% pointE(2,1:5) = [256, 256, 0, 514.2982592824391, 99.57966014922755];
% pointE(3,1:5) = [256, 0, 0, 514.1994459262231, 468.46125329551046];
% pointE(4,1:5) = [0, 0, 0, 190.92440471502894, 469.5029673620867];
% 
% pointE(5,1:5) = [0, 0, pointS(5,3)+10, 56.44078935144239, 623.3454102763126];
% pointE(6,1:5) = [0, 256, pointS(6,3)+10, 48.35160413161924, 63.15779140108941];
% pointE(7,1:5) = [256, 256, pointS(7,3)+10, 563.0016719172986, 43.86542345392883];
% pointE(8,1:5) = [256, 0, pointS(8,3)+10, 621.123967193626, 563.2944404702007];
% 


% Group Three
% pointS(1,1:5) = [0, 0, 0, 179.16413834071315, 387.0981022112845];
% pointS(2,1:5) = [0, 256, 0, 216.3971427866365, 113.18397391816666];
% pointS(3,1:5) = [256, 256, 0, 521.7056626501148, 180.97616082974065];
% pointS(4,1:5) = [256, 0, 0, 417.57184587195013, 453.2721780974126];
% 
% pointS(5,1:5) = [0, 0, 0, 179.16413834071315, 387.0981022112845];
% pointS(6,1:5) = [0, 256, 0, 216.3971427866365, 113.18397391816666];
% pointS(7,1:5) = [256, 256, 0, 521.7056626501148, 180.97616082974065];
% pointS(8,1:5) = [256, 0, 0, 417.57184587195013, 453.2721780974126];

% pointS(9,1:5) = [0, 0, 100, 13.921739362206893, 486.5315479655238];
% pointS(10,1:5) = [0, 256, 50, 160.25928833286872, 25.575232001077097];
% pointS(11,1:5) = [256, 256, 50, 621.2271544395212, 121.08980650181724];
% pointS(12,1:5) = [256, 0, 75, 475.8143239803294, 562.1024683876212];


% pointE(1,1:5) = [0, 256, 0, 216.3971427866365, 113.18397391816666];
% pointE(2,1:5) = [256, 256, 0, 521.7056626501148, 180.97616082974065];
% pointE(3,1:5) = [256, 0, 0, 417.57184587195013, 453.2721780974126];
% pointE(4,1:5) = [0, 0, 0, 179.16413834071315, 387.0981022112845];

% pointE(5,1:5) = [0, 0, pointS(5,3)+100, 13.921739362206893, 486.5315479655238];
% pointE(6,1:5) = [0, 256, pointS(6,3)+100, 160.25928833286872, 25.575232001077097];
% pointE(7,1:5) = [256, 256, pointS(7,3)+100, 621.2271544395212, 121.08980650181724];
% pointE(8,1:5) = [256, 0, pointS(8,3)+100, 475.8143239803294, 562.1024683876212];

% pointE(5,1:5) = [0, 0, 100, 13.921739362206893, 486.5315479655238];
% pointE(6,1:5) = [0, 256, 50, 160.25928833286872, 25.575232001077097];
% pointE(7,1:5) = [256, 256, 50, 621.2271544395212, 121.08980650181724];
% pointE(8,1:5) = [256, 0, 75, 475.8143239803294, 562.1024683876212];


% pointE(9,1:5) = [0, 256, 50, 160.25928833286872, 25.575232001077097];
% pointE(10,1:5) = [256, 256, 50, 621.2271544395212, 121.08980650181724];
% pointE(11,1:5) = [256, 0, 75, 475.8143239803294, 562.1024683876212];
% pointE(12,1:5) = [0, 0, 100, 13.921739362206893, 486.5315479655238];

% Group Four
% pointS = [0,0,0,148.717454997926,543.148959209743;
%           0,256,0,117.786215739890,139.685369415000;
%           256,256,0,529.078355716052,147.484066188082;
%           256,0,0,514.215474213792,516.786158051711;
%           
%           0,0,0,148.717454997926,543.148959209743;
%           0,256,0,117.786215739890,139.685369415000;
%           256,256,0,529.078355716052,147.484066188082;
%           256,0,0,514.215474213792,516.786158051711];
% 
% pointE = [0,256,0,117.786215739890,139.685369415000;
%          256,256,0,529.078355716052,147.484066188082;
%           256,0,0,514.215474213792,516.786158051711;
%           0,0,0,148.717454997926,543.148959209743;
%           
%           0,0,pointS(5,3)+10,81.7777643318937,638.447124081519;
%           0,256,pointS(6,3)+10,1.13935620604445,37.2033352894736;
%           256,256,pointS(7,3)+10,636.835689910196,66.5221861925010;
%           256,0,pointS(8,3)+10,634.497449740870,639.613359898978];
%       
      
% Group Five  
% pointS = [0,0,0,167.030868232185,482.027901120170;0,256,0,185.081059307449,164.274615580427;256,256,0,512.804659887384,185.906903486080;256,0,0,481.853493287982,508.598062396451;0,0,0,167.030868232185,482.027901120170;0,256,0,185.081059307449,164.274615580427;256,256,0,512.804659887384,185.906903486080;256,0,0,481.853493287982,508.598062396451];
% 
% pointE = [0,256,0,185.081059307449,164.274615580427;
%     256,256,0,512.804659887384,185.906903486080;
%     256,0,0,481.853493287982,508.598062396451;
%     0,0,0,167.030868232185,482.027901120170;
%     0,0,pointS(5,3)+10,22.7979465718901,636.196202095234;
%     0,256,pointS(6,3)+10,39.6585779831202,3.02200757079436;
%     256,256,pointS(7,3)+10,637.397835727412,100.740040506919;
%     256,0,pointS(8,3)+10,588.675569552253,637.244561816504];

genN = 2;
Data = LayoutDataGen(0,0,0,genN);
sew = 0;
srew = 0;
stew = 0;
sea = 0;
srea = 0;
stea = 0;
for j = 1:genN
    pointS = Data{j}.pointS;
    pointE = Data{j}.pointE;
    p1 = pointS(:,4:5);
    p2 = pointE(:,4:5);
    P1_w = pointS(:,1:3);
    P2_w = pointE(:,1:3);

    A = [180 0 320;0 180 320;0   0   1];
    for i = 1:length(p1)
        temp1 = inv(A)*[p1(i,:) 1].';
        temp1 = (temp1/temp1(3)).';
        ip1(i,:) = temp1(:,1:2);
        temp2 = inv(A)*[p2(i,:) 1].';
        temp2 = (temp2/temp2(3)).';
        ip2(i,:) = temp2(:,1:2);
    end
    
%     Copy_of_WASPnLf8ls

    R_truth = Data{j}.R;
    T_truth = Data{j}.T;

    [R1, T1, errw] = WASPnLf8ls(ip1', ip2', P1_w', P2_w',p1,A);
    sew = sew+errw;
    R_truth = Data{j}.R;
    errwR1 = cal_rotation_err(R1,R_truth);
    srew = srew + errwR1;
    T_truth = Data{j}.T;
    errT1 = cal_translation_err(T1,T_truth);
    stew = stew + errT1;

    

    [R2, T2, erra] = ASPnL(ip1', ip2', P1_w', P2_w');
    sea = sea + erra;
    errwR2 = cal_rotation_err(R2,R_truth);
    srea = srea + errwR2;
    errT2 = cal_translation_err(T2,T_truth);
    stea = stea + errT2;
end


avgew = sew/genN;
avgrew = srew/genN;
avgtew = stew/genN;

% disp()

avgea = sea/genN;
avgrea = srea/genN;
avgtea = stea/genN;



% A = [180 0 320;0 180 320;0   0   1];




% [R, T, err] = LPnL_Bar_ENull(ip1', ip2', P1_w', P2_w');
% errorEpln=reprojection_error_usingRT(P1_w,p1,R,T,A);
% fprintf('error EPnL: %.3f\n',errorEpln);

% ASPnL WSPnLType0 WSPnLType0New WSPnLType0NewTest
% 
% [R1, T1, err1] = WASPnL(ip1', ip2', P1_w', P2_w');
% 
% [R2, T2, err2] = ASPnL(ip1', ip2', P1_w', P2_w');
% 
% 
% [T1R4, T1T4] = SRPnL(ip1', ip2', P1_w', P2_w');

% P1w = P1';
% P2w = [P2_w(1:4,:);P1w(9:12,:);P1w(10:12,:);P1w(9,:)];
% ip1  = [ip1;ip2(5:8,:)];
% ip2 = [ip2;ip2(6:8,:);ip2(5,:)];
% 
% [R3, T3, err3] = ASPnL(ip1', ip2', P1w', P2w');
% 
% 
% [R4, T4] = SRPnL(ip1', ip2', P1w', P2w');

% R_truth = [[ 0.96793213  0.24133259 -0.06975647]
%             [ 0.24898738 -0.95850424  0.13883408]
%             [-0.03335669 -0.15175045 -0.98785583]];
% 
% 
% errR1 = cal_rotation_err(R1,R_truth);
% 
% T_truth = [-149.11312026   71.04161729  190.57902817];
% 
% errT1 = cal_translation_err(T1,T_truth');
% 
% errR2 = cal_rotation_err(R2,R_truth);
% 
% errT2 = cal_translation_err(T2,T_truth');
% 
% errR3 = cal_rotation_err(R3,R_truth);
% 
% errT3 = cal_translation_err(T3,T_truth');
% 
% errR4 = cal_rotation_err(R4,R_truth);
% 
% errT4 = cal_translation_err(T4,T_truth');
% 

% [T1R3, T1T3,errs] = WSPnLType0New(ip1', ip2', P1_w', P2_w');
%compute error
% pw = P1';
% p  = [p1;p2(5:8,:)];
% errorWAspnl=reprojection_error_usingRT(pw,p,R1,T1,A);
% fprintf('error Aspnl: %.3f\n',errorWAspnl);
% errorAspnl=reprojection_error_usingRT(pw,p,R2,T2,A);
% fprintf('error Aspnl: %.3f\n',errorAspnl);
% 
% 
% [R2, T2] = SRPnL(ip1', ip2', P1_w', P2_w');

% 
% x3d_h = [P1_w;P2_w];
% x2d_h = [p1;p2];
% 
% 
% [REpnp,TEpnp,Xc,best_solution]=efficient_pnp(x3d_h,x2d_h,A)
% errorEpnp=reprojection_error_usingRT(x3d_h,x2d_h,REpnp,TEpnp,A);


