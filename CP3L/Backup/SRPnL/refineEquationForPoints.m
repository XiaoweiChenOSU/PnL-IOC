function [EEA,GGA,CCA] = refineEquationForPoints(pn1,pn2,Pn1_w,Pn2_w,s)
%REFINEEQUATION Summary of this function goes here
%   Detailed explanation goes here   
%     neLine = length(pn1);
    ne_c=xnorm(cross(pn1,pn2));
        %用来计算旋转矩阵和平移矩阵关系的系数;
        
    s1 = s(1);
    s2 = s(2);
    s3 = s(3);
    
    Q=zeros(9,4);
    N=zeros(9,3);
    nx=ne_c(1,1)'; ny=ne_c(2,1)'; nz=ne_c(3,1)';      
    Py=Pn2_w(2,1)'; Pz=Pn2_w(3,1)';
    Q(1,:)=[Py*ny - 2*Py*nx*s3 + 2*Py*nz*s1 - Py*ny*s1^2 + Py*ny*s2^2 - Py*ny*s3^2+ 2*Py*nx*s1*s2+ 2*Py*nz*s2*s3+ Pz*nz + 2*Pz*nx*s2 - 2*Pz*ny*s1 - Pz*nz*s1^2 - Pz*nz*s2^2 + Pz*nz*s3^2 + 2*Pz*nx*s1*s3+ 2*Pz*ny*s2*s3,...
              nx + 2*ny*s3 - 2*nz*s2 + nx*s1^2 - nx*s2^2 - nx*s3^2 + 2*ny*s1*s2+ 2*nz*s1*s3,...
              0,...
              0];
    nx=ne_c(1,2)'; ny=ne_c(2,2)'; nz=ne_c(3,2)';
    Px=Pn2_w(1,2)'; Pz=Pn2_w(3,2)';
    Q(2,:)=[Px*nx + 2*Px*ny*s3 - 2*Px*nz*s2 + Px*nx*s1^2 - Px*nx*s2^2 - Px*nx*s3^2 + 2*Px*ny*s1*s2+ 2*Px*nz*s1*s3+ Pz*nz + 2*Pz*nx*s2 - 2*Pz*ny*s1 - Pz*nz*s1^2 - Pz*nz*s2^2 + Pz*nz*s3^2 + 2*Pz*nx*s1*s3+ 2*Pz*ny*s2*s3,...
             0,...
             ny - 2*nx*s3 + 2*nz*s1 - ny*s1^2 + ny*s2^2 - ny*s3^2+ 2*nx*s1*s2+ 2*nz*s2*s3,...
             0];  
    nx=ne_c(1,3)'; ny=ne_c(2,3)'; nz=ne_c(3,3)';
    Px=Pn2_w(1,3)'; Py=Pn2_w(2,3)';
    Q(3,:)=[Px*nx + 2*Px*ny*s3 - 2*Px*nz*s2 + Px*nx*s1^2 - Px*nx*s2^2 - Px*nx*s3^2 + 2*Px*ny*s1*s2+ 2*Px*nz*s1*s3+ Py*ny - 2*Py*nx*s3 + 2*Py*nz*s1 - Py*ny*s1^2 + Py*ny*s2^2 - Py*ny*s3^2+ 2*Py*nx*s1*s2+ 2*Py*nz*s2*s3,...
            0,...
            0,...
            nz + 2*nx*s2 - 2*ny*s1 - nz*s1^2 - nz*s2^2 + nz*s3^2 + 2*nx*s1*s3+ 2*ny*s2*s3];

    nx=ne_c(1,4)'; ny=ne_c(2,4)'; nz=ne_c(3,4)';      
    Py=Pn1_w(2,4)'; Pz=Pn1_w(3,4)';
    Q(4,:)=[Py*ny - 2*Py*nx*s3 + 2*Py*nz*s1 - Py*ny*s1^2 + Py*ny*s2^2 - Py*ny*s3^2+ 2*Py*nx*s1*s2+ 2*Py*nz*s2*s3+ Pz*nz + 2*Pz*nx*s2 - 2*Pz*ny*s1 - Pz*nz*s1^2 - Pz*nz*s2^2 + Pz*nz*s3^2 + 2*Pz*nx*s1*s3+ 2*Pz*ny*s2*s3,...
              nx + 2*ny*s3 - 2*nz*s2 + nx*s1^2 - nx*s2^2 - nx*s3^2 + 2*ny*s1*s2+ 2*nz*s1*s3,...
              0,...
              0];
    Px=Pn2_w(1,4)'; Pz=Pn2_w(3,4)';
    Q(5,:)=[Px*nx + 2*Px*ny*s3 - 2*Px*nz*s2 + Px*nx*s1^2 - Px*nx*s2^2 - Px*nx*s3^2 + 2*Px*ny*s1*s2+ 2*Px*nz*s1*s3+ Pz*nz + 2*Pz*nx*s2 - 2*Pz*ny*s1 - Pz*nz*s1^2 - Pz*nz*s2^2 + Pz*nz*s3^2 + 2*Pz*nx*s1*s3+ 2*Pz*ny*s2*s3,...
             0,...
             ny - 2*nx*s3 + 2*nz*s1 - ny*s1^2 + ny*s2^2 - ny*s3^2+ 2*nx*s1*s2+ 2*nz*s2*s3,...
             0]; 
    nx=ne_c(1,5)'; ny=ne_c(2,5)'; nz=ne_c(3,5)';      
    Px=Pn1_w(1,5)'; Pz=Pn1_w(3,5)';
    Q(6,:)=[Px*nx + 2*Px*ny*s3 - 2*Px*nz*s2 + Px*nx*s1^2 - Px*nx*s2^2 - Px*nx*s3^2 + 2*Px*ny*s1*s2+ 2*Px*nz*s1*s3+ Pz*nz + 2*Pz*nx*s2 - 2*Pz*ny*s1 - Pz*nz*s1^2 - Pz*nz*s2^2 + Pz*nz*s3^2 + 2*Pz*nx*s1*s3+ 2*Pz*ny*s2*s3,...
             0,...
             ny - 2*nx*s3 + 2*nz*s1 - ny*s1^2 + ny*s2^2 - ny*s3^2+ 2*nx*s1*s2+ 2*nz*s2*s3,...
             0]; 
    Px=Pn2_w(1,5)'; Py=Pn2_w(2,5)';
    Q(7,:)=[Px*nx + 2*Px*ny*s3 - 2*Px*nz*s2 + Px*nx*s1^2 - Px*nx*s2^2 - Px*nx*s3^2 + 2*Px*ny*s1*s2+ 2*Px*nz*s1*s3+ Py*ny - 2*Py*nx*s3 + 2*Py*nz*s1 - Py*ny*s1^2 + Py*ny*s2^2 - Py*ny*s3^2+ 2*Py*nx*s1*s2+ 2*Py*nz*s2*s3,...
            0,...
            0,...
            nz + 2*nx*s2 - 2*ny*s1 - nz*s1^2 - nz*s2^2 + nz*s3^2 + 2*nx*s1*s3+ 2*ny*s2*s3];


    nx=ne_c(1,6)'; ny=ne_c(2,6)'; nz=ne_c(3,6)';      
    Px=Pn1_w(1,6)'; Py=Pn1_w(2,6)';
    Q(8,:)=[Px*nx + 2*Px*ny*s3 - 2*Px*nz*s2 + Px*nx*s1^2 - Px*nx*s2^2 - Px*nx*s3^2 + 2*Px*ny*s1*s2+ 2*Px*nz*s1*s3+ Py*ny - 2*Py*nx*s3 + 2*Py*nz*s1 - Py*ny*s1^2 + Py*ny*s2^2 - Py*ny*s3^2+ 2*Py*nx*s1*s2+ 2*Py*nz*s2*s3,...
            0,...
            0,...
            nz + 2*nx*s2 - 2*ny*s1 - nz*s1^2 - nz*s2^2 + nz*s3^2 + 2*nx*s1*s3+ 2*ny*s2*s3];

    Py=Pn2_w(2,6)'; Pz=Pn2_w(3,6)';
    Q(9,:)=[Py*ny - 2*Py*nx*s3 + 2*Py*nz*s1 - Py*ny*s1^2 + Py*ny*s2^2 - Py*ny*s3^2+ 2*Py*nx*s1*s2+ 2*Py*nz*s2*s3+ Pz*nz + 2*Pz*nx*s2 - 2*Pz*ny*s1 - Pz*nz*s1^2 - Pz*nz*s2^2 + Pz*nz*s3^2 + 2*Pz*nx*s1*s3+ 2*Pz*ny*s2*s3,...
              nx + 2*ny*s3 - 2*nz*s2 + nx*s1^2 - nx*s2^2 - nx*s3^2 + 2*ny*s1*s2+ 2*nz*s1*s3,...
              0,...
              0];

    N(1:3,:)=-ne_c(:,1:3).';
    N(4:2:9,:)=-ne_c(:,4:6).';
    N(5:2:9,:)=-ne_c(:,4:6).';

    if abs(det(N.'*N)) < 2e-10
        CCA=(pinv(N.'*N)*N.')*Q;
    else
        CCA=((N.'*N)\N.')*Q;
    end

    EEA=Q-N*CCA;
    GGA=EEA.'*EEA;
        
end

