%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
%   ZDT6
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function f = CameraPose(s, xs, xe, Pn1_w, Pn2_w, cH)

    npart = 3;  
    neLine = length(xs);
    ne_c=xnorm(cross(xs,xe));

    Q=zeros(2*neLine,34);
    N=zeros(2*neLine,3);
    nx=ne_c(1,1:npart)'; ny=ne_c(2,1:npart)'; nz=ne_c(3,1:npart)';
    Px=Pn1_w(1,1:npart)'; Py=Pn1_w(2,1:npart)'; Pz=Pn1_w(3,1:npart)';
    Q(1:2:2*npart,:)=[Px.*nx+Py.*ny+Pz.*nz,...    %1
              2*Py.*nz-2*Pz.*ny,...       %s1
              2*Pz.*nx-2*Px.*nz,...       %s2
              2*Px.*ny-2*Py.*nx,...       %s3
              Px.*nx-Py.*ny-Pz.*nz,...     %s1^2
              2.*Px.*ny+2*Py.*nx,...      %s1*s2
              2.*Px.*nz+2*Pz.*nx,...       %s1*s3
              Py.*ny-Px.*nx-Pz.*nz,...     %s2^2
              2*Py.*nz+2*Pz.*ny,...       %s2*s3
              Pz.*nz-Px.*nx-Py.*ny,...     %s3^2
              [0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0],[0;0;0]];
    nx=ne_c(1,1)'; ny=ne_c(2,1)'; nz=ne_c(3,1)';      
    Py=Pn2_w(2,1)'; Pz=Pn2_w(3,1)';
    Q(2,:)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
    nx=ne_c(1,2)'; ny=ne_c(2,2)'; nz=ne_c(3,2)';
    Px=Pn2_w(1,2)'; Pz=Pn2_w(3,2)';
    Q(4,:)=[Px.*nx+Pz.*nz,...
              -2*Pz.*ny,...
              2*Pz.*nx-2*Px.*nz,...
              2*Px.*ny,...
              Px.*nx-Pz.*nz,...
              2.*Px.*ny,...
              2.*Px.*nz+2*Pz.*nx,...
              -Px.*nx-Pz.*nz,...
              2*Pz.*ny,...
              Pz.*nz-Px.*nx,...
              0,0,0,0,0,0,0,0,ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny,0,0,0,0,0,0,0,0];  
    nx=ne_c(1,3)'; ny=ne_c(2,3)'; nz=ne_c(3,3)';
    Px=Pn2_w(1,3)'; Py=Pn2_w(2,3)';
    Q(6,:)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];


    nx=ne_c(1,4)'; ny=ne_c(2,4)'; nz=ne_c(3,4)';      
    Py=Pn1_w(2,4)'; Pz=Pn1_w(3,4)';
    Q(7,:)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
    Px=Pn2_w(1,4)'; Pz=Pn2_w(3,4)';
    Q(8,:)=[Px.*nx+Pz.*nz,...
              -2*Pz.*ny,...
              2*Pz.*nx-2*Px.*nz,...
              2*Px.*ny,...
              Px.*nx-Pz.*nz,...
              2.*Px.*ny,...
              2.*Px.*nz+2*Pz.*nx,...
              -Px.*nx-Pz.*nz,...
              2*Pz.*ny,...
              Pz.*nz-Px.*nx,...
              0,0,0,0,0,0,0,0,   ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny,0,0,0,0,0,0,0,0];        

    nx=ne_c(1,5)'; ny=ne_c(2,5)'; nz=ne_c(3,5)';      
    Px=Pn1_w(1,5)'; Pz=Pn1_w(3,5)';
    Q(9,:)=[Px.*nx+Pz.*nz,...
              -2*Pz.*ny,...
              2*Pz.*nx-2*Px.*nz,...
              2*Px.*ny,...
              Px.*nx-Pz.*nz,...
              2.*Px.*ny,...
              2.*Px.*nz+2*Pz.*nx,...
              -Px.*nx-Pz.*nz,...
              2*Pz.*ny,...
              Pz.*nz-Px.*nx,...
              0,0,0,0,0,0,0,0,   ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny,0,0,0,0,0,0,0,0];        
    Px=Pn2_w(1,5)'; Py=Pn2_w(2,5)';
    Q(10,:)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];

    nx=ne_c(1,6)'; ny=ne_c(2,6)'; nz=ne_c(3,6)';      
    Px=Pn1_w(1,6)'; Py=Pn1_w(2,6)';
    Q(11,:)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];
    Py=Pn2_w(2,6)'; Pz=Pn2_w(3,6)';
    Q(12,:)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];

    N(1:2:2*neLine,:)=-ne_c.';
    N(2:2:2*neLine,:)=-ne_c.';

    if abs(det(N.'*N)) < 2e-10
        CC=(pinv(N.'*N)*N.')*Q;
    else
        CC=((N.'*N)\N.')*Q;
    end

    EE=Q-N*CC;
    GG=EE.'*EE;


    s1=s(1);
    s2=s(2);
    s3=s(3);
    s4=s(4);
    s5=s(5);
    s6=s(6);
    factor=1/(1+s1^2+s2^2+s3^2);
    R = CGR2(s(1:3));

    sr=[1,s1,s2,s3,s1^2,s1*s2,s1*s3,s2^2,s2*s3,s3^2,...
    s4,s4*s2,s4*s3,s4*(s1^2),s4*s1*s2,s4*s1*s3,s4*(s2^2),s4*(s3^2),...
    s5,s5*s1,s5*s3,s5*(s1^2),s5*s1*s2,s5*(s2^2),s5*s2*s3,s5*(s3^2),...
    s6,s6*s1,s6*s2,s6*(s1^2),s6*s1*s3,s6*(s2^2),s6*s2*s3,s6*(s3^2)].';       
    t=factor*CC*sr; 
    
    cT = -inv(R)*t;
    errT = abs(cH -cT(2));

    err1 = sr' * GG * sr + errT;
    err2 = sum(abs(EE*sr));
    f = [err1;err2];
  
    

function R= CGR2(s)

s1= s(1);
s2= s(2);
s3= s(3);

R= [1+s1^2-s2^2-s3^2,   2*s1*s2-2*s3,   2*s2+2*s1*s3;
    2*s3+2*s1*s2,   1-s1^2+s2^2-s3^2,   2*s2*s3-2*s1;
    2*s1*s3-2*s2,   2*s1+2*s2*s3,   1-s1^2-s2^2+s3^2];
 
R= R/(1+s1*s1+s2*s2+s3*s3);

return
