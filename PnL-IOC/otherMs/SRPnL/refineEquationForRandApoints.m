function [EE,GG,CC] = refineEquationForRandApoints(xs, xe, Pn1_w, Pn2_w, cH)

%first compute the weight of each line and the normal of the interpretation plane passing through to camera center and the line 

    npart = 3;  
    neLine = length(xs);
    ne_c=xnorm(cross(xs,xe));

    Q=zeros(2*neLine,66);
    N=zeros(2*neLine,3);
    nx=ne_c(1,1:npart)'; ny=ne_c(2,1:npart)'; nz=ne_c(3,1:npart)';
    Px=Pn1_w(1,1:npart)'; Py=Pn1_w(2,1:npart)'; Pz=Pn1_w(3,1:npart)';
    Q(1:2:2*npart,1:10)=[Px.*nx+Py.*ny+Pz.*nz,...    %1
              2*Py.*nz-2*Pz.*ny,...       %s1
              2*Pz.*nx-2*Px.*nz,...       %s2
              2*Px.*ny-2*Py.*nx,...       %s3
              Px.*nx-Py.*ny-Pz.*nz,...     %s1^2
              2.*Px.*ny+2*Py.*nx,...      %s1*s2
              2.*Px.*nz+2*Pz.*nx,...       %s1*s3
              Py.*ny-Px.*nx-Pz.*nz,...     %s2^2
              2*Py.*nz+2*Pz.*ny,...       %s2*s3
              Pz.*nz-Px.*nx-Py.*ny,...     %s3^2
             ];
    nx=ne_c(1,1)'; ny=ne_c(2,1)'; nz=ne_c(3,1)';      
    Py=Pn2_w(2,1)'; Pz=Pn2_w(3,1)';
    Q(2,1:18)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx];
    nx=ne_c(1,2)'; ny=ne_c(2,2)'; nz=ne_c(3,2)';
    Px=Pn2_w(1,2)'; Pz=Pn2_w(3,2)';
    Q(4,1:26)=[Px.*nx+Pz.*nz,...
              -2*Pz.*ny,...
              2*Pz.*nx-2*Px.*nz,...
              2*Px.*ny,...
              Px.*nx-Pz.*nz,...
              2.*Px.*ny,...
              2.*Px.*nz+2*Pz.*nx,...
              -Px.*nx-Pz.*nz,...
              2*Pz.*ny,...
              Pz.*nz-Px.*nx,...
              0,0,0,0,0,0,0,0,ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny];  
    nx=ne_c(1,3)'; ny=ne_c(2,3)'; nz=ne_c(3,3)';
    Px=Pn2_w(1,3)'; Py=Pn2_w(2,3)';
    Q(6,1:34)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];
    nx=ne_c(1,4)'; ny=ne_c(2,4)'; nz=ne_c(3,4)';      
    Py=Pn1_w(2,4)'; Pz=Pn1_w(3,4)';
    Q(7,1:18)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx];
    Px=Pn2_w(1,4)'; Pz=Pn2_w(3,4)';
    Q(8,1:26)=[Px.*nx+Pz.*nz,...
              -2*Pz.*ny,...
              2*Pz.*nx-2*Px.*nz,...
              2*Px.*ny,...
              Px.*nx-Pz.*nz,...
              2.*Px.*ny,...
              2.*Px.*nz+2*Pz.*nx,...
              -Px.*nx-Pz.*nz,...
              2*Pz.*ny,...
              Pz.*nz-Px.*nx,...
              0,0,0,0,0,0,0,0,ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny];        

    nx=ne_c(1,5)'; ny=ne_c(2,5)'; nz=ne_c(3,5)';      
    Px=Pn1_w(1,5)'; Pz=Pn1_w(3,5)';
    Q(9,1:26)=[Px.*nx+Pz.*nz,...
              -2*Pz.*ny,...
              2*Pz.*nx-2*Px.*nz,...
              2*Px.*ny,...
              Px.*nx-Pz.*nz,...
              2.*Px.*ny,...
              2.*Px.*nz+2*Pz.*nx,...
              -Px.*nx-Pz.*nz,...
              2*Pz.*ny,...
              Pz.*nz-Px.*nx,...
              0,0,0,0,0,0,0,0,ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny];        
    Px=Pn2_w(1,5)'; Py=Pn2_w(2,5)';
    Q(10,1:34)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];

    nx=ne_c(1,6)'; ny=ne_c(2,6)'; nz=ne_c(3,6)';      
    Px=Pn1_w(1,6)'; Py=Pn1_w(2,6)';
    Q(11,1:34)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];
    Py=Pn2_w(2,6)'; Pz=Pn2_w(3,6)';
    Q(12,1:18)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx];

    N(1:2:2*neLine,:)=-ne_c.';
    N(2:2:2*neLine,:)=-ne_c.';

    if abs(det(N.'*N)) < 2e-10
        CC=(pinv(N.'*N)*N.')*Q;
    else
        CC=((N.'*N)\N.')*Q;
    end

    EE=Q-N*CC;


    c = CC;
    
    
    EE(2*neLine+1,:) = [...
        c(2) + cH;
        2*c(3) + c(5); 
        c(8); 
        - 2*c(1) + c(11);
        - c(2) + 2*c(6) + c(14) + 2*cH;
        2*c(1) + 2*c(9) + c(17);
        - 2*c(4) + 2*c(12) + c(20);
        c(2) + c(23) + 2*cH;
        2*c(3) - 2*c(7) + c(26);
        - c(2) - 2*c(10) + c(29) + 2*cH;
        0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;0;       
        - c(5) + 2*c(15);
        c(8);
        - c(11) - 2*c(28);
        - c(14) + cH;
        c(23) + cH;
        - c(29) + cH;
        2*c(4)  - c(8) + 2*c(18); 
        - c(11) - 2*c(13) + 2*c(21); 
        c(5) + 2*c(7) + 2*c(24);
        2*c(9)  + c(11) - 2*c(22);
        - c(5) - 2*c(19) + 2*c(30);
        - c(8) + 2*c(12) - 2*c(25);
        2*c(13) - c(17);
        - c(20); 
        c(17) + 2*c(22);
        2*c(24) + c(26);
        - c(20); 
        - c(26) + 2*c(30);
        c(14) + 2*c(16) - c(23) + 2*cH;
        - c(14) - c(29) + 2*cH;
        - c(23) + 2*c(27) + c(29) + 2*cH;
        2*c(6) + 2*c(10) - 2*c(16) + 2*c(27); 
        2*c(15) + 2*c(19) - c(26);
        2*c(18) + c(20)+ 2*c(25);
        - c(17) + 2*c(21) + 2*c(28);
        0;0;0;0;0;0;
   ]';

   EE(neLine+2,:) = [0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0,0];
   EE(neLine+3,:) = [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0];
   EE(neLine+4,:) = [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0];
   EE(neLine+5,:) = [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0];
   EE(neLine+6,:) = [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0];
   EE(neLine+7,:) = [0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1];
  

   GG=EE.'*EE;


end
