function [EEA,GGA,CCA] = refineEquation(p1,pn1,pn2,Pn1_w,Pn2_w,R,cH)
%REFINEEQUATION Summary of this function goes here
%   Detailed explanation goes here
    npart = length(p1);    
    neLine = length(pn1);
    ne_c=xnorm(cross(pn1,pn2));
        %用来计算旋转矩阵和平移矩阵关系的系数;
    nLe = 2*neLine;     
    Q=zeros(nLe,56);
    N=zeros(nLe,3);
    nx=ne_c(1,1:npart)'; ny=ne_c(2,1:npart)'; nz=ne_c(3,1:npart)';
    Px=Pn1_w(1,1:npart)'; Py=Pn1_w(2,1:npart)'; Pz=Pn1_w(3,1:npart)';
    Q(1:2:2*npart,1:10)=[Px.*nx+Py.*ny+Pz.*nz,...    %1
              2*Py.*nz-2*Pz.*ny,...       %s1
              2*Pz.*nx-2*Px.*nz,...       %s2
              2*Px.*ny-2*Py.*nx,...       %s3
              Px.*nx-Py.*ny-Pz.*nz,...     %s1^2
              2.*Px.*ny+2*Py.*nx,...      %s1*s2
              2.*Px.*nz+2*Pz.*nx,...       %s1*s3
              Py.*ny-Px.*nx-Pz.*nz,...     %s2^2
              2*Py.*nz+2*Pz.*ny,...       %s2*s3
              Pz.*nz-Px.*nx-Py.*ny,...     %s3^2
             ];
    nx=ne_c(1,1)'; ny=ne_c(2,1)'; nz=ne_c(3,1)';      
    Py=Pn2_w(2,1)'; Pz=Pn2_w(3,1)';
    Q(2,1:18)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx];
    nx=ne_c(1,2)'; ny=ne_c(2,2)'; nz=ne_c(3,2)';
    Px=Pn2_w(1,2)'; Pz=Pn2_w(3,2)';
    Q(4,1:26)=[Px.*nx+Pz.*nz,...
              -2*Pz.*ny,...
              2*Pz.*nx-2*Px.*nz,...
              2*Px.*ny,...
              Px.*nx-Pz.*nz,...
              2.*Px.*ny,...
              2.*Px.*nz+2*Pz.*nx,...
              -Px.*nx-Pz.*nz,...
              2*Pz.*ny,...
              Pz.*nz-Px.*nx,...
              0,0,0,0,0,0,0,0,ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny];  
    nx=ne_c(1,3)'; ny=ne_c(2,3)'; nz=ne_c(3,3)';
    Px=Pn2_w(1,3)'; Py=Pn2_w(2,3)';
    Q(6,1:34)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];

    nx=ne_c(1,4)'; ny=ne_c(2,4)'; nz=ne_c(3,4)';      
    Py=Pn1_w(2,4)'; Pz=Pn1_w(3,4)';
    Q(7,1:18)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx];
    Px=Pn2_w(1,4)'; Pz=Pn2_w(3,4)';
    Q(8,1:26)=[Px.*nx+Pz.*nz,...
              -2*Pz.*ny,...
              2*Pz.*nx-2*Px.*nz,...
              2*Px.*ny,...
              Px.*nx-Pz.*nz,...
              2.*Px.*ny,...
              2.*Px.*nz+2*Pz.*nx,...
              -Px.*nx-Pz.*nz,...
              2*Pz.*ny,...
              Pz.*nz-Px.*nx,...
              0,0,0,0,0,0,0,0,ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny];        

    nx=ne_c(1,5)'; ny=ne_c(2,5)'; nz=ne_c(3,5)';      
    Px=Pn1_w(1,5)'; Pz=Pn1_w(3,5)';
    Q(9,1:26)=[Px.*nx+Pz.*nz,...
              -2*Pz.*ny,...
              2*Pz.*nx-2*Px.*nz,...
              2*Px.*ny,...
              Px.*nx-Pz.*nz,...
              2.*Px.*ny,...
              2.*Px.*nz+2*Pz.*nx,...
              -Px.*nx-Pz.*nz,...
              2*Pz.*ny,...
              Pz.*nz-Px.*nx,...
              0,0,0,0,0,0,0,0,ny,2*nz,-2*nx,-ny,2*nx,ny,2*nz,-ny];        
    Px=Pn2_w(1,5)'; Py=Pn2_w(2,5)';
    Q(10,1:34)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];

    nx=ne_c(1,6)'; ny=ne_c(2,6)'; nz=ne_c(3,6)';      
    Px=Pn1_w(1,6)'; Py=Pn1_w(2,6)';
    Q(11,1:34)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];
    Py=Pn2_w(2,6)'; Pz=Pn2_w(3,6)';
    Q(12,1:18)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx];

    N(1:2:nLe,:)=-ne_c.';
    N(2:2:nLe,:)=-ne_c.';
       
    
    if abs(det(N.'*N)) < 2e-10
        CCA=(pinv(N.'*N)*N.')*Q;
    else
        CCA=((N.'*N)\N.')*Q;
    end

    EEA=Q-N*CCA;
    
    
    EEA(nLe+1,1:40) = [0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0,0];
    EEA(nLe+2,1:40) = [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0];
    EEA(nLe+3,1:40) = [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0];
    EEA(nLe+4,1:40) = [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0];
    EEA(nLe+5,1:40) = [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0];
    EEA(nLe+6,1:40) = [0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1];
    EEA(nLe+7,:) = [cH,0,0,0,cH,0,0,cH,0,cH,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,-2,0,2,0,0,-1,1,-1,2,0,0,2,0];

    tempL = zeros(1,56);
    tempL(41) = 1; tempL(45) = 1; tempL(47) = 1; tempL(48) = 1; 
    EEA(nLe+8,:) = CCA(1,:) -  tempL;
    tempL = zeros(1,56);
    tempL(42) = 1; tempL(49) = 1; tempL(50) = 1; tempL(51) = 1; 
    EEA(nLe+9,:) = CCA(2,:) -  tempL;
    tempL = zeros(1,56);
    tempL(43) = 1; tempL(53) = 1; tempL(54) = 1; tempL(56) = 1; 
    EEA(nLe+10,:) = CCA(3,:) -  tempL;
    
    
    nx=ne_c(1,1); ny=ne_c(2,1); nz=ne_c(3,1); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+11,:) = Q(1,:) +  tempL;
    
    nx=ne_c(1,1); ny=ne_c(2,1); nz=ne_c(3,1); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+12,:) = Q(2,:) +  tempL;
    
    nx=ne_c(1,2); ny=ne_c(2,2); nz=ne_c(3,2); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+13,:) = Q(3,:) +  tempL;
    
    nx=ne_c(1,2); ny=ne_c(2,2); nz=ne_c(3,2); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+14,:) = Q(4,:) +  tempL;
    
    nx=ne_c(1,3); ny=ne_c(2,3); nz=ne_c(3,3); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+15,:) = Q(5,:) +  tempL;
    
    nx=ne_c(1,3); ny=ne_c(2,3); nz=ne_c(3,3); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+16,:) = Q(6,:) +  tempL;
    
    nx=ne_c(1,4); ny=ne_c(2,4); nz=ne_c(3,4); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+17,:) = Q(7,:) +  tempL;
    
    nx=ne_c(1,4); ny=ne_c(2,4); nz=ne_c(3,4); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+18,:) = Q(8,:) +  tempL;
    
    nx=ne_c(1,5); ny=ne_c(2,5); nz=ne_c(3,5); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+19,:) = Q(9,:) +  tempL;
    
    nx=ne_c(1,5); ny=ne_c(2,5); nz=ne_c(3,5); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+20,:) = Q(10,:) +  tempL;
    
    
    nx=ne_c(1,6); ny=ne_c(2,6); nz=ne_c(3,6); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+21,:) = Q(11,:) +  tempL;
    
    nx=ne_c(1,6); ny=ne_c(2,6); nz=ne_c(3,6); 
    tempL = zeros(1,56);
    tempL(41) = nx; tempL(42) = ny; tempL(43) = nz; tempL(45) = nx; tempL(47) = nx; tempL(48) = nx;
    tempL(49) = ny; tempL(50) = ny; tempL(51) = ny; tempL(53) = nz; tempL(54) = nz; tempL(56) = nz;
    EEA(nLe+22,:) = Q(12,:) +  tempL;
   
    
    
    
    
    GGA=EEA.'*EEA;
    
    
        
end

