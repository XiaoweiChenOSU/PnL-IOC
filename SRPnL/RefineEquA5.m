function [EE,GG,CC] = RefineEquA5(p, W)


    pn1 = [p(:,1) p(:,1) p(:,1) p(:,1) p(:,1) p(:,2) p(:,2) p(:,2) p(:,2) p(:,3) p(:,3) p(:,3) p(:,4) p(:,4) p(:,5)];
    pn2 = [p(:,2) p(:,3) p(:,4) p(:,5) p(:,6) p(:,3) p(:,4) p(:,5) p(:,6) p(:,4) p(:,5) p(:,6) p(:,5) p(:,6) p(:,6)];
    nxs = pn1;
    nxe = pn2;
    n_nc = xcross_mat(nxs,nxe);
    ne_c = xnorm(n_nc);
    Pn1_w = [W(:,1) W(:,1) W(:,1) W(:,1) W(:,1) W(:,2) W(:,2) W(:,2) W(:,2) W(:,3) W(:,3) W(:,3) W(:,4) W(:,4) W(:,5)];
    Pn2_w = [W(:,2) W(:,3) W(:,4) W(:,5) W(:,6) W(:,3) W(:,4) W(:,5) W(:,6) W(:,4) W(:,5) W(:,6) W(:,5) W(:,6) W(:,6)];
 
    neLine = length(pn1);


    Q=zeros(2*neLine,48);
    N=zeros(2*neLine,3);
    for i = 1:9
        nx=ne_c(1,i); ny=ne_c(2,i); nz=ne_c(3,i);
        Px=Pn1_w(1,i); Py=Pn1_w(2,i); Pz=Pn1_w(3,i);
        Q(i,1:10)=[Px.*nx+Py.*ny+Pz.*nz,...    %1
              2*Py.*nz-2*Pz.*ny,...       %s1
              2*Pz.*nx-2*Px.*nz,...       %s2
              2*Px.*ny-2*Py.*nx,...       %s3
              Px.*nx-Py.*ny-Pz.*nz,...     %s1^2
              2.*Px.*ny+2*Py.*nx,...      %s1*s2
              2.*Px.*nz+2*Pz.*nx,...       %s1*s3
              Py.*ny-Px.*nx-Pz.*nz,...     %s2^2
              2*Py.*nz+2*Pz.*ny,...       %s2*s3
              Pz.*nz-Px.*nx-Py.*ny,...     %s3^2
             ];
    end
    
    for i = 10:12
        nx=ne_c(1,i); ny=ne_c(2,i); nz=ne_c(3,i);
        Px=Pn1_w(1,i); Py=Pn1_w(2,i);
        Q(i,1:18)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];
    end
    for i = 13:14
        nx=ne_c(1,i); ny=ne_c(2,i); nz=ne_c(3,i);
        Py=Pn1_w(2,i); Pz=Pn1_w(3,i);
        Q(i,1:26)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              0,0,0,0,0,0,0,0,nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx];
    end
    for i = 15:15
        nx=ne_c(1,i); ny=ne_c(2,i); nz=ne_c(3,i);
        Px=Pn1_w(1,i); Py=Pn1_w(2,i);
        Q(i,1:34)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];
    end
    
    for j = 1:15
        nx=ne_c(1,j); ny=ne_c(2,j); nz=ne_c(3,j);
        if j==1
             Px=Pn2_w(1,j); Py=Pn2_w(2,j); Pz=Pn2_w(3,j);
             Q(j+15,1:10)=[Px.*nx+Py.*ny+Pz.*nz,...    %1
                  2*Py.*nz-2*Pz.*ny,...       %s1
                  2*Pz.*nx-2*Px.*nz,...       %s2
                  2*Px.*ny-2*Py.*nx,...       %s3
                  Px.*nx-Py.*ny-Pz.*nz,...     %s1^2
                  2.*Px.*ny+2*Py.*nx,...      %s1*s2
                  2.*Px.*nz+2*Pz.*nx,...       %s1*s3
                  Py.*ny-Px.*nx-Pz.*nz,...     %s2^2
                  2*Py.*nz+2*Pz.*ny,...       %s2*s3
                  Pz.*nz-Px.*nx-Py.*ny,...     %s3^2
                 ];
        end
        if j==2 || j==6
             Px=Pn2_w(1,j); Py=Pn2_w(2,j);
             Q(j+15,1:18)=[Px.*nx+Py.*ny,...
                  2*Py.*nz,...
                  -2*Px.*nz,...
                  2*Px.*ny-2*Py.*nx,...
                  Px.*nx-Py.*ny,...
                  2.*Px.*ny+2*Py.*nx,...
                  2.*Px.*nz,...
                  Py.*ny-Px.*nx,...
                  2*Py.*nz,...
                  -Px.*nx-Py.*ny,...
                  nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];
        end
        if j==3 || j==7 || j==10
             Py=Pn2_w(2,j); Pz=Pn2_w(3,j);
             Q(j+15,1:26)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              0,0,0,0,0,0,0,0,nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx];
        end
        if j==4 || j==8 || j==11 || j==13
             Px=Pn2_w(1,j); Py=Pn2_w(2,j);
             Q(j+15,1:34)=[Px.*nx+Py.*ny,...
              2*Py.*nz,...
              -2*Px.*nz,...
              2*Px.*ny-2*Py.*nx,...
              Px.*nx-Py.*ny,...
              2.*Px.*ny+2*Py.*nx,...
              2.*Px.*nz,...
              Py.*ny-Px.*nx,...
              2*Py.*nz,...
              -Px.*nx-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nz,-2*ny,2*nx,-nz,2*nx,-nz,2*ny,nz];
        end
        if j==5 || j==9 || j==12 || j==14 || j==15
             Py=Pn2_w(2,j); Pz=Pn2_w(3,j);
             Q(j+15,1:42)=[Py.*ny+Pz.*nz,...
              2*Py.*nz-2*Pz.*ny,...
              2*Pz.*nx,...
              -2*Py.*nx,...
              -Py.*ny-Pz.*nz,...
              2*Py.*nx,...
              2*Pz.*nx,...
              Py.*ny-Pz.*nz,...
              2*Py.*nz+2*Pz.*ny,...
              Pz.*nz-Py.*ny,...
              0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,nx,-2*nz,2*ny,nx,2*ny,2*nz,-nx,-nx];
         end
    end
    
    N(1:neLine,:)=-ne_c.';
    N(neLine+1:2*neLine,:)=-ne_c.';

    if abs(det(N.'*N)) < 2e-10
        CC=(pinv(N.'*N)*N.')*Q;
    else
        CC=((N.'*N)\N.')*Q;
    end

    EE=Q-N*CC;


    EE(2*neLine+1,:) = [0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0,0];
    EE(2*neLine+2,:) = [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0,0];
    EE(2*neLine+3,:) = [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0,0];
    EE(2*neLine+4,:) = [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0,0];
    EE(2*neLine+5,:) = [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,0];
    EE(2*neLine+6,:) = [0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1];
  

    GG=EE.'*EE;
    
end
